apiVersion: helm.toolkit.fluxcd.io/v2
kind: HelmRelease
metadata:
  name: omni
spec:
  interval: 30m
  chartRef:
    kind: OCIRepository
    name: app-template
  maxHistory: 2
  install:
    createNamespace: true
    remediation:
      retries: 3
  upgrade:
    cleanupOnFail: true
    remediation:
      retries: 3
  uninstall:
    keepHistory: false
  values:
    defaultPodOptions:
      securityContext:
        runAsUser: 0
        runAsGroup: 0
        fsGroup: 0
      hostNetwork: true
      dnsPolicy: ClusterFirstWithHostNet
    controllers:
      omni:
        annotations:
          reloader.stakater.com/auto: "true"
        initContainers:
          cleanup-wireguard:
            image:
              repository: alpine
              tag: latest
            command:
              - /bin/sh
              - -c
              - |
                apk add --no-cache iproute2 psmisc
                echo "Cleaning up existing WireGuard interfaces and processes..."
                
                # Clean up any existing siderolink interfaces
                if ip link show siderolink 2>/dev/null; then
                  echo "Removing existing siderolink interface"
                  ip link delete siderolink
                fi
                
                # Clean up any WireGuard interfaces with the problematic IPv6
                for iface in $(ip -6 addr show | grep "fdae:41e4:649b:9303" | awk '{print $NF}'); do
                  echo "Removing interface $iface with problematic IPv6"
                  ip link delete "$iface" 2>/dev/null || true
                done
                
                # Kill any processes using port 8090
                echo "Killing processes on port 8090"
                fuser -k 8090/tcp 2>/dev/null || true
                fuser -k 8090/udp 2>/dev/null || true
                
                # Wait a moment for cleanup
                sleep 2
                echo "Cleanup complete"
            securityContext:
              privileged: true
              capabilities:
                add: ["NET_ADMIN", "SYS_ADMIN"]
        containers:
          app:
            image:
              repository: ghcr.io/siderolabs/omni
              tag: v1.1.3
              pullPolicy: IfNotPresent
            envFrom:
              - secretRef:
                  name: omni-secret
            args:
              - --name=$(OMNI_NAME)
              - --account-id=$(OMNI_ACCOUNT_UUID)
              - --initial-users=$(OMNI_ADMIN_EMAILS)
              - --etcd-embedded=true
              - --etcd-embedded-unsafe-fsync=true
              - --private-key-source=file:///omni.asc
              # bind on all interfaces for Service/Ingress
              - --bind-addr=0.0.0.0:8080
              - --k8s-proxy-bind-addr=0.0.0.0:8100
              - --machine-api-bind-addr=0.0.0.0:8090
              # advertised externally
              - --advertised-api-url=$(ADVERTISED_API_URL)
              - --advertised-kubernetes-proxy-url=$(ADVERTISED_K8S_PROXY_URL)
              - --machine-api-advertised-url=$(SIDEROLINK_API_ADVERTISED_URL)
              # SAML
              - --auth-saml-enabled=$(AUTH_SAML_ENABLED)
              - --auth-saml-url=$(AUTH_SAML_METADATA_URL)
            resources:
              requests:
                memory: 500Mi
                cpu: 10m
              limits:
                memory: 16Gi
            securityContext:
              capabilities:
                add: ["NET_ADMIN", "SYS_MODULE"]
              privileged: true
            ports:
              - { name: http,    containerPort: 8080 }
              - { name: machine, containerPort: 8090 }
              - { name: kube,    containerPort: 8100 }
    service:
      omni:
        controller: omni
        type: ClusterIP
        ports:
          http:    { port: 8080, targetPort: http }
          machine: { port: 8090, targetPort: machine }
          kube:    { port: 8100, targetPort: kube }
    persistence:
      etcd:
        existingClaim: omni
        globalMounts:
          - path: /_out/etcd
      dev-net-tun:
        type: hostPath
        hostPath: /dev/net/tun
        hostPathType: CharDevice
        globalMounts:
          - path: /dev/net/tun
      deploy-key:
        type: secret
        name: omni-secret
        defaultMode: 256
        globalMounts:
          - path: /omni.asc
            subPath: OMNI_ASC