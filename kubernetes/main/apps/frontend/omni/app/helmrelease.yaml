apiVersion: helm.toolkit.fluxcd.io/v2
kind: HelmRelease
metadata:
  name: omni
  namespace: frontend
spec:
  interval: 30m
  chartRef:
    kind: OCIRepository
    name: app-template
  maxHistory: 2
  install:
    createNamespace: true
    remediation:
      retries: 3
  upgrade:
    cleanupOnFail: true
    remediation:
      retries: 3
  uninstall:
    keepHistory: false
  values:
    # Pod-wide defaults (schema-safe)
    defaultPodOptions:
      hostNetwork: false
      dnsPolicy: ClusterFirst
      securityContext:
        runAsUser: 0
        runAsGroup: 0
        fsGroup: 0
      annotations:
        # Unconfine only this container by name ("app") if your cluster enforces AppArmor
        container.apparmor.security.beta.kubernetes.io/app: unconfined

    controllers:
      omni:
        # Safer during port moves
        strategy: Recreate
        annotations:
          reloader.stakater.com/auto: "true"

        containers:
          app:
            image:
              repository: ghcr.io/siderolabs/omni
              tag: v1.1.3
              pullPolicy: IfNotPresent

            envFrom:
              - secretRef:
                  name: omni-secret

            # Omni flags (Machine API moved to 8091 to avoid previous bind clash)
            args:
              - --name=$(OMNI_NAME)
              - --account-id=$(OMNI_ACCOUNT_UUID)
              - --initial-users=$(OMNI_ADMIN_EMAILS)
              - --etcd-embedded=true
              - --etcd-embedded-unsafe-fsync=true
              - --private-key-source=file:///omni.asc
              - --bind-addr=0.0.0.0:8080
              - --k8s-proxy-bind-addr=0.0.0.0:8100
              - --machine-api-bind-addr=0.0.0.0:8091
              - --advertised-api-url=$(ADVERTISED_API_URL)
              - --advertised-kubernetes-proxy-url=$(ADVERTISED_K8S_PROXY_URL)
              - --machine-api-advertised-url=$(SIDEROLINK_API_ADVERTISED_URL)
              - --auth-saml-enabled=$(AUTH_SAML_ENABLED)
              - --auth-saml-url=$(AUTH_SAML_METADATA_URL)

            # Correct placement for per-container securityContext
            securityContext:
              allowPrivilegeEscalation: false
              capabilities:
                add: ["NET_ADMIN"]
              runAsUser: 0
              runAsGroup: 0
              seccompProfile:
                type: Unconfined

            # Request the /dev/net/tun device from the generic device plugin
            resources:
              limits:
                memory: 16Gi
                squat.ai/tun: "1"
              requests:
                cpu: 10m
                memory: 500Mi

            # Expose ports by name for services/probes
            ports:
              http:
                containerPort: 8080
              machine:
                containerPort: 8091
              kube:
                containerPort: 8100

            probes:
              liveness:
                enabled: true
                custom: true
                spec:
                  httpGet:
                    path: /api/health
                    port: http
                  initialDelaySeconds: 60
                  periodSeconds: 30
                  timeoutSeconds: 10
                  failureThreshold: 3
              readiness:
                enabled: true
                custom: true
                spec:
                  httpGet:
                    path: /api/health
                    port: http
                  initialDelaySeconds: 30
                  periodSeconds: 10
                  timeoutSeconds: 5
                  failureThreshold: 3

    service:
      omni:
        controller: omni
        type: ClusterIP
        ports:
          http:
            port: 8080
            targetPort: http
          machine:
            port: 8091
            targetPort: machine
          kube:
            port: 8100
            targetPort: kube

    persistence:
      etcd:
        existingClaim: omni
        globalMounts:
          - path: /_out/etcd
      deploy-key:
        type: secret
        name: omni-secret
        defaultMode: 256
        globalMounts:
          - path: /omni.asc
            subPath: OMNI_ASC
