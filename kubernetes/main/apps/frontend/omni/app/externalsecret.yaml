---
apiVersion: external-secrets.io/v1
kind: ExternalSecret
metadata:
  name: omni
spec:
  secretStoreRef:
    kind: ClusterSecretStore
    name: onepassword-connect
  target:
    name: omni-secret
    template:
      engineVersion: v2
      data:
        # Omni identity & admin
        OMNI_ACCOUNT_UUID: "{{ .OMNI_ACCOUNT_UUID }}"
        OMNI_NAME: "omni"
        OMNI_ADMIN_EMAILS: "{{ .OMNI_ADMIN_EMAILS }}"  # comma-separated list

        # SAML (Authentik)
        AUTH_SAML_ENABLED: "true"
        AUTH_SAML_METADATA_URL: "{{ .AUTH_SAML_METADATA_URL }}"  # e.g. https://auth.CHANGEME_DOMAIN/application/saml/<slug>/metadata/

        # GPG private key (ASCII-armored) used by Omni (omni.asc)
        OMNI_ASC: "{{ .OMNI_ASC }}"

        # Advertised URLs (what clients see)
        ADVERTISED_API_URL: "https://omni.haynesnetwork.com/"
        ADVERTISED_K8S_PROXY_URL: "https://kube.omni.haynesnetwork.com/"
        SIDEROLINK_API_ADVERTISED_URL: "https://api.omni.haynesnetwork.com/"
        SIDEROLINK_WIREGUARD_ADVERTISED_ADDR: "192.168.40.210:51820"

        # TLS
        OMNI_TLS_CRT: "{{ .OMNI_TLS_CRT }}"
        OMNI_TLS_KEY: "{{ .OMNI_TLS_KEY }}"

        OMNI_UI_TLS_CRT: "{{ .OMNI_UI_TLS_CRT }}"
        OMNI_UI_TLS_KEY: "{{ .OMNI_UI_TLS_KEY }}"
  dataFrom:
    - extract:
        key: omni